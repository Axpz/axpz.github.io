<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.4">Jekyll</generator><link href="/feed.xml" rel="self" type="application/atom+xml" /><link href="/" rel="alternate" type="text/html" /><updated>2025-01-23T17:30:41+00:00</updated><id>/feed.xml</id><title type="html">Xianping</title><subtitle>Cost-effective hybrid cloud computing and resource scheduling on Kubernetes.
</subtitle><author><name>Axpz</name><email>axpzhang@gmail.com</email></author><entry><title type="html">Hacker News 热门话题 top 10 2025-01-23</title><link href="/hacknews/2025/01/23/17-29-36-hackernews_report.html" rel="alternate" type="text/html" title="Hacker News 热门话题 top 10 2025-01-23" /><published>2025-01-23T09:29:36+00:00</published><updated>2025-01-23T09:29:36+00:00</updated><id>/hacknews/2025/01/23/17:29:36-hackernews_report</id><content type="html" xml:base="/hacknews/2025/01/23/17-29-36-hackernews_report.html"><![CDATA[<p>Hacker News 热门话题 2025-01-23 17:29:36</p>

<ol>
  <li><strong>Bunster 工具介绍</strong><br />
Bunster 是一个可以将 bash 脚本编译成独立可执行文件的工具，为脚本部署和分发提供了便利。
    <ul>
      <li><a href="https://github.com/yassinebenaid/bunster">Bunster: Compile bash scripts to self contained executables</a></li>
    </ul>
  </li>
  <li><strong>迷幻图形介绍</strong><br />
文章介绍了迷幻图形的历史和设计原理，为设计师和艺术家提供了灵感。
    <ul>
      <li><a href="https://benpence.com/blog/post/psychedelic-graphics-0">Psychedelic Graphics: An Introduction</a></li>
    </ul>
  </li>
  <li><strong>TMSU 命令行工具</strong><br />
TMSU 是一个命令行工具，用于给文件系统打标签和查看虚拟标签文件系统，增强了文件管理的灵活性。
    <ul>
      <li><a href="https://tmsu.org/">TMSU: Command-line tool for applying tags and viewing virtual tagged filesystem</a></li>
    </ul>
  </li>
  <li><strong>自制开源笔记本电脑</strong><br />
一个开发者展示了他从头开始制作开源笔记本电脑的过程，引起了社区的广泛关注。
    <ul>
      <li><a href="https://www.byran.ee/posts/creation/">Show HN: I made an open-source laptop from scratch</a></li>
    </ul>
  </li>
  <li><strong>处理文件的困难</strong><br />
文章讨论了在现代编程中处理文件的复杂性，以及如何优化文件操作。
    <ul>
      <li><a href="https://danluu.com/deconstruct-files/">Working with Files Is Hard</a></li>
    </ul>
  </li>
  <li><strong>轨道绘图仪</strong><br />
介绍了一种名为轨道绘图仪的数学绘图工具，可以创建复杂的几何图形。
    <ul>
      <li><a href="https://www.redblobgames.com/x/1903-orbit-spirograph/">Orbit Spirograph</a></li>
    </ul>
  </li>
  <li><strong>Intrinsic 招聘信息</strong><br />
YC W23 孵化的公司 Intrinsic 发布了招聘信息，寻找技术人才。
    <ul>
      <li><a href="item?id=42805699">Intrinsic (YC W23) Is Hiring</a></li>
    </ul>
  </li>
  <li><strong>libmodulor TS 库</strong><br />
展示了一个用于构建多平台应用的 TypeScript 库 libmodulor，强调了其“有意见”的设计哲学。
    <ul>
      <li><a href="https://github.com/c100k/libmodulor">Show HN: libmodulor – An opinionated TS library to build multi-platform apps</a></li>
    </ul>
  </li>
  <li><strong>第三垒（棒球术语）</strong><br />
文章探讨了棒球中的“第三垒”概念，以及它在统计学和战术上的重要性。
    <ul>
      <li><a href="https://www.americanscientist.org/article/third-base">Third Base</a></li>
    </ul>
  </li>
  <li><strong>伦敦最中心的羊</strong><br />
一篇有趣的文章探讨了伦敦最中心的羊的位置，以及这个概念背后的城市地理学。
    <ul>
      <li><a href="https://diamondgeezer.blogspot.com/2025/01/londons-most-central-sheep.html">Where is London’s most central sheep?</a></li>
    </ul>
  </li>
</ol>]]></content><author><name>Axpz</name><email>axpzhang@gmail.com</email></author><category term="hacknews" /><category term="news" /><category term="tech" /><summary type="html"><![CDATA[Hacker News 热门话题 2025-01-23 17:29:36]]></summary></entry><entry><title type="html">Hacker News 热门话题 top 10 2025-01-23</title><link href="/hacknews/2025/01/23/17-18-32-hackernews_report.html" rel="alternate" type="text/html" title="Hacker News 热门话题 top 10 2025-01-23" /><published>2025-01-23T09:18:32+00:00</published><updated>2025-01-23T09:18:32+00:00</updated><id>/hacknews/2025/01/23/17:18:32-hackernews_report</id><content type="html" xml:base="/hacknews/2025/01/23/17-18-32-hackernews_report.html"><![CDATA[<p>Hacker News 热门话题 2025-01-23 17:18:32</p>

<ol>
  <li><strong>Bunster 工具介绍</strong>：一个可以将 bash 脚本编译成独立可执行文件的工具，为脚本开发者提供了便利。
    <ul>
      <li>Bunster: Compile bash scripts to self contained executables: https://github.com/yassinebenaid/bunster</li>
    </ul>
  </li>
  <li><strong>迷幻图形介绍</strong>：一篇关于迷幻图形的介绍文章，探讨了这种视觉艺术的风格和特点。
    <ul>
      <li>Psychedelic Graphics: An Introduction: https://benpence.com/blog/post/psychedelic-graphics-0</li>
    </ul>
  </li>
  <li><strong>TMSU 命令行工具</strong>：一个用于应用标签和查看虚拟标记文件系统的命令行工具。
    <ul>
      <li>TMSU: Command-line tool for applying tags and viewing virtual tagged filesystem: https://tmsu.org/</li>
    </ul>
  </li>
  <li><strong>开源笔记本电脑制作</strong>：一个开发者展示了他从头开始制作的开源笔记本电脑。
    <ul>
      <li>Show HN: I made an open-source laptop from scratch: https://www.byran.ee/posts/creation/</li>
    </ul>
  </li>
  <li><strong>轨道绘图仪</strong>：一篇关于轨道绘图仪的介绍文章，探讨了这种数学绘图工具的工作原理。
    <ul>
      <li>Orbit Spirograph: https://www.redblobgames.com/x/1903-orbit-spirograph/</li>
    </ul>
  </li>
  <li><strong>libmodulor TS库</strong>：一个用于构建多平台应用的意见性TypeScript库。
    <ul>
      <li>Show HN: libmodulor – An opinionated TS library to build multi-platform apps: https://github.com/c100k/libmodulor</li>
    </ul>
  </li>
  <li><strong>Intrinsic 招聘信息</strong>：一家 YC W23 孵化的公司正在招聘。
    <ul>
      <li>Intrinsic (YC W23) Is Hiring: item?id=42805699</li>
    </ul>
  </li>
  <li><strong>文件操作的难点</strong>：一篇讨论文件操作难点的文章，分析了文件系统和文件操作的复杂性。
    <ul>
      <li>Working with Files Is Hard: https://danluu.com/deconstruct-files/</li>
    </ul>
  </li>
  <li><strong>第三垒</strong>：一篇关于棒球中第三垒位置的文章，探讨了这个位置的重要性和特点。
    <ul>
      <li>Third Base: https://www.americanscientist.org/article/third-base</li>
    </ul>
  </li>
  <li><strong>伦敦最中心的羊</strong>：一篇探讨伦敦最中心位置的羊的文章，提供了有趣的地理和文化信息。
    <ul>
      <li>
        <h2 id="where-is-londons-most-central-sheep-httpsdiamondgeezerblogspotcom202501londons-most-central-sheephtml">Where is London’s most central sheep?: https://diamondgeezer.blogspot.com/2025/01/londons-most-central-sheep.html</h2>
      </li>
    </ul>
  </li>
</ol>]]></content><author><name>Axpz</name><email>axpzhang@gmail.com</email></author><category term="hacknews" /><category term="news" /><category term="tech" /><summary type="html"><![CDATA[Hacker News 热门话题 2025-01-23 17:18:32]]></summary></entry><entry><title type="html">Hacker News 热门话题 top 10 2025-01-23</title><link href="/hacknews/2025/01/23/16-57-19-hackernews_report.html" rel="alternate" type="text/html" title="Hacker News 热门话题 top 10 2025-01-23" /><published>2025-01-23T08:57:19+00:00</published><updated>2025-01-23T08:57:19+00:00</updated><id>/hacknews/2025/01/23/16:57:19-hackernews_report</id><content type="html" xml:base="/hacknews/2025/01/23/16-57-19-hackernews_report.html"><![CDATA[<p>Hacker News 热门话题 2025-01-23 16:57:19</p>

<ol>
  <li><strong>Bunster：将 Bash 脚本编译成独立可执行文件的工具</strong>：一个 GitHub 项目，允许用户将 Bash 脚本编译成独立的可执行文件，提高脚本的便携性和执行效率。
    <ul>
      <li><a href="https://github.com/yassinebenaid/bunster">Bunster: Compile bash scripts to self contained executables</a></li>
    </ul>
  </li>
  <li><strong>Psychedelic Graphics：介绍</strong>：一篇博客文章，介绍了迷幻图形的历史和技术，探讨了这种风格在现代设计中的应用。
    <ul>
      <li><a href="https://benpence.com/blog/post/psychedelic-graphics-0">Psychedelic Graphics: An Introduction</a></li>
    </ul>
  </li>
  <li><strong>Show HN：从头开始制作的开源笔记本电脑</strong>：一个开发者展示了他如何从零开始制作一个开源笔记本电脑，包括硬件和软件的集成。
    <ul>
      <li><a href="https://www.byran.ee/posts/creation/">Show HN: I made an open-source laptop from scratch</a></li>
    </ul>
  </li>
  <li><strong>Show HN：libmodulor – 用于构建多平台应用的 TypeScript 库</strong>：一个 GitHub 项目，提供了一个有特定观点的 TypeScript 库，用于构建跨平台应用程序。
    <ul>
      <li><a href="https://github.com/c100k/libmodulor">Show HN: libmodulor – An opinionated TS library to build multi-platform apps</a></li>
    </ul>
  </li>
  <li><strong>Orbit Spirograph：数学艺术</strong>：一个关于轨道绘图仪的数学艺术文章，探讨了这种绘图工具的数学原理和美学。
    <ul>
      <li><a href="https://www.redblobgames.com/x/1903-orbit-spirograph/">Orbit Spirograph (2019)</a></li>
    </ul>
  </li>
  <li><strong>Third Base：棒球术语的科学解释</strong>：一篇科学美国人的文章，解释了棒球术语“第三垒”背后的科学原理。
    <ul>
      <li><a href="https://www.americanscientist.org/article/third-base">Third Base (2001)</a></li>
    </ul>
  </li>
  <li><strong>TMSU：命令行工具，用于应用标签和查看虚拟标记文件系统</strong>：一个命令行工具，允许用户为文件和目录添加标签，并查看一个基于标签的虚拟文件系统。
    <ul>
      <li><a href="https://tmsu.org/">TMSU: Command-line tool for applying tags and viewing virtual tagged filesystem</a></li>
    </ul>
  </li>
  <li><strong>伦敦最中心的羊在哪里？</strong>：一篇博客文章，探讨了伦敦最中心的羊的位置，以及这个概念背后的地理和文化意义。
    <ul>
      <li><a href="https://diamondgeezer.blogspot.com/2025/01/londons-most-central-sheep.html">Where is London’s most central sheep?</a></li>
    </ul>
  </li>
  <li><strong>英国微型巨头</strong>：一篇博客文章，讨论了英国微型计算机产业的历史和影响，以及它如何塑造了现代技术。
    <ul>
      <li><a href="https://www.abortretry.fail/p/the-british-micro-behemoth">The British Micro Behemoth</a></li>
    </ul>
  </li>
  <li><strong>查看压缩算法</strong>：一篇博客文章，深入探讨了不同的压缩算法，包括它们的工作原理和应用场景。
    <ul>
      <li><a href="https://cefboud.github.io/posts/compression/">Taking a Look at Compression Algorithms</a></li>
    </ul>
  </li>
</ol>]]></content><author><name>Axpz</name><email>axpzhang@gmail.com</email></author><category term="hacknews" /><category term="news" /><category term="tech" /><summary type="html"><![CDATA[Hacker News 热门话题 2025-01-23 16:57:19]]></summary></entry><entry><title type="html">git workflow</title><link href="/k8s/2025/01/23/09-47-52-gitworkflow.html" rel="alternate" type="text/html" title="git workflow" /><published>2025-01-23T01:47:52+00:00</published><updated>2025-01-23T01:47:52+00:00</updated><id>/k8s/2025/01/23/09:47:52-gitworkflow</id><content type="html" xml:base="/k8s/2025/01/23/09-47-52-gitworkflow.html"><![CDATA[<p>一图胜千文，这张图真是让我爱不释手啊</p>

<p><img src="/assets/images/git-workflow.gif" alt="git workflow" /></p>

<h1 id="git-的核心概念">Git 的核心概念</h1>

<p>Git 是一种分布式版本控制系统，主要用于管理代码的变更。它通过多个状态和区间，帮助开发者跟踪、管理和共享代码。</p>

<h2 id="工作目录-working-directory">工作目录 (Working Directory)</h2>

<p>本地文件夹，包含所有正在开发和修改的代码，文件有两种状态</p>
<ul>
  <li><strong>未跟踪(Untracked)</strong>：新文件，Git尚未开始管理</li>
  <li><strong>已跟踪(Tracked)</strong>: 被Git管理的文件，可用于修改、未修改或暂存状态</li>
</ul>

<h2 id="暂存区-staging-area">暂存区 (Staging Area)</h2>

<ul>
  <li>又称为<strong>Index</strong>， 是一个中间区域，用于保存你准备提交到本地仓库的更改</li>
  <li>暂存区可以理解为提交的草稿区，只有暂存的文件才会被提交</li>
</ul>

<h2 id="本地仓库local-repo">本地仓库(Local Repo)</h2>

<ul>
  <li>包含所有的提交历史，保存了项目的版本变化</li>
  <li>通过<code class="language-plaintext highlighter-rouge">git commit</code>将暂存区的更改记录到本地仓库</li>
</ul>

<h2 id="远程仓库remote-repo">远程仓库(Remote Repo)</h2>
<ul>
  <li>通常是托管在服务器或云端 (GitHub, GitLab)的仓库</li>
  <li>本地仓库的更改可以通过<code class="language-plaintext highlighter-rouge">git push</code> 推送到远程仓库，工团队成员共享</li>
</ul>

<h1 id="git-的设计哲学">Git 的设计哲学</h1>

<h2 id="分布式版本控制">分布式版本控制</h2>
<ul>
  <li>Git的核心在于每个开发者都拥有完成的仓库副本，确保即使没有网络链接，也能进行代码的管理和回滚</li>
</ul>

<h2 id="文件的三个区域">文件的三个区域</h2>
<ul>
  <li><strong>工作目录</strong> <strong>暂存区</strong> <strong>本地仓库</strong> 的分离，使得修改和提交具有更高的灵活性</li>
</ul>

<h2 id="基于快照而非差异">基于快照而非差异</h2>
<ul>
  <li>Git 通过报错文件快照 (snapshot) 而非改动，提高了性能和版本管理效率</li>
</ul>

<h2 id="高效分支管理">高效分支管理</h2>
<ul>
  <li>Git 的分支(Branch) 轻量且易于合并，便于多人协作和快速开发</li>
</ul>

<p><strong>Note:</strong>
每次提交就是一张快照照片： 项目所有文件的当前状态都被记录下来。
未变动的文件只存一次： Git 不会重复保存相同的文件，依靠引用来避免冗余。
高效与完整结合： 快照是对版本状态的完整记录，但通过引用和压缩技术使其存储效率极高。
通过这种快照机制，Git 既保证了性能，又能方便地管理代码版本，让开发者专注于编程而无需关心底层实现。</p>

<p>假设有一个项目包含三个文件：<code class="language-plaintext highlighter-rouge">file1.txt</code>、<code class="language-plaintext highlighter-rouge">file2.txt</code> 和 <code class="language-plaintext highlighter-rouge">file3.txt</code>，以下是文件的变更和提交的流程：</p>

<p><strong>初次提交</strong></p>

<ul>
  <li>
    <p>Git 保存所有文件的完整内容（Blob），并生成 Tree 和 Commit 对象。</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Commit</span> <span class="err">→</span> <span class="n">Tree</span> <span class="err">→</span> <span class="p">[</span><span class="nb">Blob</span><span class="p">(</span><span class="n">file1</span><span class="p">),</span> <span class="nb">Blob</span><span class="p">(</span><span class="n">file2</span><span class="p">),</span> <span class="nb">Blob</span><span class="p">(</span><span class="n">file3</span><span class="p">)]</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>第二次提交</strong></p>

<ul>
  <li>修改了 <code class="language-plaintext highlighter-rouge">file2.txt</code>，其他文件未变动。</li>
  <li>Git 只保存 <code class="language-plaintext highlighter-rouge">file2.txt</code> 的新 Blob，对未变动的文件使用之前的引用。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Commit</span> <span class="err">→</span> <span class="n">Tree</span> <span class="err">→</span> <span class="p">[</span><span class="nb">Blob</span><span class="p">(</span><span class="n">file1</span><span class="p">),</span> <span class="nb">Blob</span><span class="p">(</span><span class="n">new_file2</span><span class="p">),</span> <span class="nb">Blob</span><span class="p">(</span><span class="n">file3</span><span class="p">)]</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>第三次提交</strong></p>

<ul>
  <li>修改了 <code class="language-plaintext highlighter-rouge">file3.txt</code>。</li>
  <li>
    <p>Git 保存 <code class="language-plaintext highlighter-rouge">file3.txt</code> 的新 Blob，其余文件继续引用之前的 Blob。</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Commit</span> <span class="err">→</span> <span class="n">Tree</span> <span class="err">→</span> <span class="p">[</span><span class="nb">Blob</span><span class="p">(</span><span class="n">file1</span><span class="p">),</span> <span class="nb">Blob</span><span class="p">(</span><span class="n">new_file2</span><span class="p">),</span> <span class="nb">Blob</span><span class="p">(</span><span class="n">new_file3</span><span class="p">)]</span>
</code></pre></div>    </div>
  </li>
</ul>]]></content><author><name>Axpz</name><email>axpzhang@gmail.com</email></author><category term="k8s" /><category term="git" /><category term="tech" /><summary type="html"><![CDATA[一图胜千文，这张图真是让我爱不释手啊]]></summary></entry><entry><title type="html">Gateway DNAT网络不可用问题排查和解决方案</title><link href="/k8s/2025/01/23/20-00-00-traefik-gateway.html" rel="alternate" type="text/html" title="Gateway DNAT网络不可用问题排查和解决方案" /><published>2025-01-23T01:47:52+00:00</published><updated>2025-01-23T01:47:52+00:00</updated><id>/k8s/2025/01/23/20:00:00-traefik-gateway</id><content type="html" xml:base="/k8s/2025/01/23/20-00-00-traefik-gateway.html"><![CDATA[<p>Gateway DNAT网络不可用问题排查和解决方案</p>

<h2 id="问题描述">问题描述</h2>

<p>在个人云主机上做了两个DNAT规则，将流量导入到私有环境中的虚拟机，但安装了Traefik（K3s）之后，发现当前网络不可用，并且出现了 400 错误。</p>

<h3 id="测试">测试</h3>

<ul>
  <li>在本地请求网络服务时没有问题。</li>
  <li>请求云主机网络服务时出现 400 错误，说明问题出在新安装的Traefik上。</li>
</ul>

<h3 id="traffic-flow-调试分析">Traffic Flow 调试分析</h3>

<p><strong>1. 深入查看之前的NAT规则，发现没有问题：</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-A</span> PREROUTING <span class="nt">-p</span> tcp <span class="nt">--dport</span> 80 <span class="nt">-d</span> 74.121.149.207 <span class="nt">-j</span> DNAT <span class="nt">--to-destination</span> 10.4.0.3:80
<span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-A</span> PREROUTING <span class="nt">-p</span> tcp <span class="nt">--dport</span> 443 <span class="nt">-d</span> 74.121.149.207 <span class="nt">-j</span> DNAT <span class="nt">--to-destination</span> 10.4.0.3:443
<span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-A</span> POSTROUTING <span class="nt">-o</span> eth0 <span class="nt">-j</span> MASQUERADE
<span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-A</span> POSTROUTING <span class="nt">-o</span> wg0 <span class="nt">-j</span> MASQUERADE
</code></pre></div></div>

<p><strong>2. 继续查看所有的DNAT规则，发现多了两条规则：</strong></p>

<p>通过 iptables-save | grep 74.121.149.207 查看：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-A</span> KUBE-SERVICES <span class="nt">-d</span> 74.121.149.207/32 <span class="nt">-p</span> tcp <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"kube-system/traefik:web loadbalancer IP"</span> <span class="nt">-m</span> tcp <span class="nt">--dport</span> 80 <span class="nt">-j</span> KUBE-EXT-UQMCRMJZLI3FTLDP
<span class="nt">-A</span> KUBE-SERVICES <span class="nt">-d</span> 74.121.149.207/32 <span class="nt">-p</span> tcp <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"kube-system/traefik:websecure loadbalancer IP"</span> <span class="nt">-m</span> tcp <span class="nt">--dport</span> 443 <span class="nt">-j</span> KUBE-EXT-CVG3OEGEH7H5P3HQ
</code></pre></div></div>

<p><strong>从以上规则可以看出，原先的规则被新添加的规则覆盖了。这是由于Traefik作为Kubernetes的Ingress Controller，它会动态管理网络流量，并且在 KUBE-SERVICES 链中插入新的规则，导致原本的DNAT规则失效。</strong></p>

<p>看到这里，我们不妨深入追踪一下traefik的网络流量</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>k get svc <span class="nt">-owide</span> <span class="nt">-n</span> kube-system
NAMESPACE     NAME               TYPE           CLUSTER-IP    EXTERNAL-IP            PORT<span class="o">(</span>S<span class="o">)</span>   AGE   SELECTOR
              kubernetes         ClusterIP      10.43.0.1     &lt;none&gt;                 443/TCP   14d   &lt;none&gt;
kube-system   traefik            LoadBalancer   10.43.2.186   74.121.149.207         80:30974/TCP,443:31017/TCP   36h   app.kubernetes.io/instance<span class="o">=</span>traefik-kube-system,app.kubernetes.
</code></pre></div></div>

<p>iptables-save
```bash iptables-save</p>

<p>-A KUBE-SERVICES -d 74.121.149.207/32 -p tcp -m comment –comment “kube-system/traefik:web loadbalancer IP” -m tcp –dport 80 -j KUBE-EXT-UQMCRMJZLI3FTLDP</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
nft list table nat  
```bash
chain KUBE-EXT-UQMCRMJZLI3FTLDP {
          counter packets 305 bytes 15115 jump KUBE-MARK-MASQ
        counter packets 305 bytes 15115 jump KUBE-SVC-UQMCRMJZLI3FTLDP
}

chain KUBE-MARK-MASQ {
        counter packets 2 bytes 112 meta mark set mark or 0x4000
}

chain KUBE-SVC-UQMCRMJZLI3FTLDP {
    meta l4proto tcp ip saddr != 10.42.0.0/16 ip daddr 10.43.2.186  tcp dport 80 counter packets 0 bytes 0 jump KUBE-MARK-MASQ
    counter packets 307 bytes 15235 jump KUBE-SEP-6ESQAMORAOJ7JTEK
}

# 该链处理从外部发送到服务的流量，先通过源地址检查（排除 Kubernetes 内部流量），然后将流量转发到后端 Pod 的链（KUBE-SEP-6ESQAMORAOJ7JTEK）

chain KUBE-SEP-6ESQAMORAOJ7JTEK {
    ip saddr 10.42.0.35  counter packets 0 bytes 0 jump KUBE-MARK-MASQ
    meta l4proto tcp   counter packets 307 bytes 15235 dnat to 10.42.0.35:8000
}

# dnat to 10.42.0.35:8000
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>k get po <span class="nt">-owide</span> <span class="nt">-A</span>
kube-system   traefik-b7b68d8cb-dkt4v                   1/1     Running     0             34h   10.42.0.35   calm-baud-1.localdomain   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>至此网络进入到了traefik的pod中</p>

<h2 id="解决方案">解决方案</h2>

<p>既然安装了traefik，那我们不如使用traefik来统一处理所有的流量，让它成为ingress/egress的统一口</p>

<p>废话少说，直接贴上traefik的proxy配置吧</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">hacknews-service</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ExternalName</span>
  <span class="na">externalName</span><span class="pi">:</span> <span class="s">news.ycombinator.com</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">443</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">443</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">traefik.containo.us/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Middleware</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">hacknews-strip-prefix</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">stripPrefix</span><span class="pi">:</span>
    <span class="na">prefixes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">/hacknews"</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">traefik.containo.us/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IngressRoute</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">hacknews-proxy</span> <span class="c1"># proxy to external service</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">entryPoints</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">websecure</span>
  <span class="na">routes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span> <span class="s2">"</span><span class="s">PathPrefix(`/hacknews`)"</span>
      <span class="na">kind</span><span class="pi">:</span> <span class="s">Rule</span>
      <span class="na">middlewares</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">hacknews-strip-prefix</span>
      <span class="na">services</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">hacknews-service</span>
          <span class="na">port</span><span class="pi">:</span> <span class="m">443</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">github-service</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ExternalName</span>
  <span class="na">externalName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10.4.0.3"</span> <span class="c1"># Directly using the backend Pod's IP address</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">traefik.containo.us/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IngressRoute</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">github-proxy</span> <span class="c1"># proxy to backend service</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">entryPoints</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">web</span>
  <span class="na">routes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span> <span class="s">PathPrefix(`/github/webhook`)</span>  <span class="c1"># 根据 GitHub webhook 的域名和路径进行路由</span>
      <span class="na">kind</span><span class="pi">:</span> <span class="s">Rule</span>
      <span class="na">services</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">github-service</span>  <span class="c1"># 使用一个服务名称，你可以创建一个名为 service 的服务，或者直接使用 IP 地址</span>
          <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>]]></content><author><name>Axpz</name><email>axpzhang@gmail.com</email></author><category term="k8s" /><category term="k8s" /><category term="network" /><category term="ai" /><summary type="html"><![CDATA[Gateway DNAT网络不可用问题排查和解决方案]]></summary></entry><entry><title type="html">关于开源许可协议</title><link href="/k8s/2025/01/22/09-47-52-open-source-license.html" rel="alternate" type="text/html" title="关于开源许可协议" /><published>2025-01-22T01:47:52+00:00</published><updated>2025-01-22T01:47:52+00:00</updated><id>/k8s/2025/01/22/09:47:52-open-source-license</id><content type="html" xml:base="/k8s/2025/01/22/09-47-52-open-source-license.html"><![CDATA[<p>常见的开源许可协议，可以理解为两条线</p>

<ol>
  <li>软件类产品，从宽松到严格依次是
    <div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ------- 松 ----    --- 紧 -------  
 MIT License  
       Apache License 2.0  
           LGPL (Lesser General Public License)  
                 GPL (GNU General Public License)  
     BSD License  
</code></pre></div>    </div>
  </li>
  <li>创作类非软件产品<br />
CC (Creative Commons License)，适合开源非软件类作品，如文档、艺术作品、图像、音频等</li>
</ol>

<p>详细如下：</p>

<h1 id="mit-licnese">MIT Licnese</h1>
<p><strong>全称</strong>：麻省理工学院许可协议</p>
<h2 id="特点">特点</h2>
<ul>
  <li>非常宽松，允许任何用途，包括商业用途</li>
  <li>可以修改、分发代码，甚至闭源分发
    <h2 id="限制">限制</h2>
  </li>
  <li>必须保留原始的版权声明和许可信息
    <h2 id="适用场景">适用场景</h2>
  </li>
  <li>适合希望代码被广泛采用且不限制用途的项目</li>
</ul>

<h1 id="apache-license-20">Apache License 2.0</h1>
<p><strong>全称</strong>：Apache License 2.0 许可协议</p>

<h2 id="特点-1">特点</h2>
<ul>
  <li>允许免费使用、修改和分发(包括商业用途)</li>
  <li>明确授权专利，保护用户免受专利纠纷</li>
  <li>允许闭源分发，需要遵守相关条款</li>
</ul>

<h2 id="限制-1">限制</h2>
<ul>
  <li>必须保留原始的版权声明和许可信息</li>
  <li>修改后的代码需明确说明变更内容</li>
</ul>

<h2 id="适用场景-1">适用场景</h2>
<ul>
  <li>适合需要专利保护且希望明确授权条款的项目</li>
</ul>

<h1 id="gpl-gnu-general-public-license">GPL (GNU General Public License)</h1>
<p><strong>全称</strong>：通用公共许可协议</p>

<h2 id="特点-2">特点</h2>
<ul>
  <li>强制开源，任何基于GPL代码的衍生项目必须公开开源</li>
  <li>允许自由使用、修改和分发，但必须保持衍生品同样为GPL协议</li>
</ul>

<h2 id="限制-2">限制</h2>
<ul>
  <li>商业化受限，因为衍生品不能闭源</li>
  <li>必须提供完整的源代码，包括修改部分</li>
</ul>

<h2 id="适用场景-2">适用场景</h2>
<ul>
  <li>适合重视软件自由、希望强制开源的项目</li>
</ul>

<h1 id="lgpl-lesser-general-public-license">LGPL (Lesser General Public License)</h1>
<p><strong>全称</strong>：宽松通用公共许可协议</p>

<h2 id="特点-3">特点</h2>
<ul>
  <li>相对GPL更宽松，允许软件动态链接到非GPL的代码</li>
  <li>用户可以闭源分发自己的软件，只要不修改LGPL的代码</li>
</ul>

<h2 id="限制-3">限制</h2>
<ul>
  <li>修改的LGPL的代码必须开源并使用相同的协议分发</li>
</ul>

<h2 id="适用场景-3">适用场景</h2>
<ul>
  <li>适合开发Library, 希望代码被广泛采用而不是强制整个项目开源</li>
</ul>

<h1 id="bsd-license">BSD License</h1>
<p><strong>全称</strong>：Berkeley Software Distribution License</p>

<h2 id="特点-4">特点</h2>
<ul>
  <li>类似MIT，非常宽松，允许任何用途，包括商业化</li>
  <li>可闭源分发，无需公开修改后的代码</li>
</ul>

<h2 id="限制-4">限制</h2>
<ul>
  <li>必须保留版权声明</li>
  <li>不允许使用原作者的名字进行推广</li>
</ul>

<h2 id="适用场景-4">适用场景</h2>
<ul>
  <li>适合希望代码被广泛使用且对使用方式限制较少的项目</li>
</ul>

<h1 id="mpl-mozilla-public-license">MPL (Mozilla Public License)</h1>
<p><strong>全称</strong>：Mozilla 公共开源许可协议</p>

<h2 id="特点-5">特点</h2>
<ul>
  <li>比较宽松，允许闭源和商业化使用，但对修改后的代码需要开源</li>
  <li>仅要求修改开源的文件，而不是整个项目</li>
</ul>

<h2 id="限制-5">限制</h2>
<ul>
  <li>修改后的MPL文件必须开源并使用相同协议分发</li>
</ul>

<h2 id="适用场景-5">适用场景</h2>
<ul>
  <li>适合开发需要部分开源，又保留商业化可能的项目</li>
</ul>

<h1 id="cc-creative-commons-license">CC (Creative Commons License)</h1>
<p><strong>全称</strong>：创作公共许可</p>

<h2 id="特点-6">特点</h2>
<ul>
  <li>专注于创意作品，例如文字、音乐、图片，而非软件</li>
  <li>有多种版本，如CC BY、CC BY-SA、 CC BY-NC 等，根据是否允许商业用途、是否要求署名等区分</li>
</ul>

<h2 id="限制-6">限制</h2>
<ul>
  <li>根据选择的版本不同，可能限制商用或者二次创作</li>
</ul>

<h2 id="适用场景-6">适用场景</h2>
<ul>
  <li>适合开源非软件类作品</li>
</ul>]]></content><author><name>Axpz</name><email>axpzhang@gmail.com</email></author><category term="k8s" /><category term="license" /><category term="tech" /><summary type="html"><![CDATA[常见的开源许可协议，可以理解为两条线]]></summary></entry><entry><title type="html">Hacker News 热门话题 2025-01-20</title><link href="/hacknews/2025/01/19/11-47-52-hacknews-top10.html" rel="alternate" type="text/html" title="Hacker News 热门话题 2025-01-20" /><published>2025-01-19T17:20:31+00:00</published><updated>2025-01-19T17:20:31+00:00</updated><id>/hacknews/2025/01/19/11:47:52-hacknews-top10</id><content type="html" xml:base="/hacknews/2025/01/19/11-47-52-hacknews-top10.html"><![CDATA[<p>Hacker News 热门话题 2025-01-20 01:20:31</p>

<ol>
  <li><strong>TikTok 在美国被禁用</strong>：TikTok 在美国被禁用的新闻引起了广泛关注，讨论了这一事件对用户访问量的影响以及替代应用的激增。
    <ul>
      <li><a href="https://techcrunch.com/2025/01/18/tiktok-goes-dark-in-the-u-s/">TikTok goes dark in the US</a></li>
      <li><a href="https://blog.cloudflare.com/tiktok-ban-traffic-decline-alternatives-rednote/">TikTok Shut Down: Data Shows 85% Drop in US Access (and Surge to Alternatives)</a></li>
    </ul>
  </li>
  <li><strong>发光材料制作</strong>：一个关于如何制作发光的锶铝酸盐材料的项目，展示了 DIY 科学实验的趣味性和教育价值。
    <ul>
      <li><a href="https://maurycyz.com/projects/strontium_aluminate/">Making glow-in-the-dark Strontium Aluminate</a></li>
    </ul>
  </li>
  <li><strong>模糊测试书籍</strong>：《The Fuzzing Book》提供了关于模糊测试的深入知识和实践指南，是安全测试领域的重要资源。
    <ul>
      <li><a href="https://www.fuzzingbook.org/">The Fuzzing Book</a></li>
    </ul>
  </li>
  <li><strong>Forgejo 自托管软件仓库</strong>：Forgejo 是一个轻量级的自托管软件仓库，为开发者提供了一个私有的代码管理解决方案。
    <ul>
      <li><a href="https://forgejo.org/">Forgejo: A self-hosted lightweight software forge</a></li>
    </ul>
  </li>
  <li><strong>构建数据库教程</strong>：一个教程，教你如何在3000行代码内构建一个无依赖的数据库，展示了数据库开发的基础知识。
    <ul>
      <li><a href="https://build-your-own.org/blog/20251015_db_in_3000/">Build a Database in 3000 Lines with 0 Dependencies</a></li>
    </ul>
  </li>
  <li><strong>GauntletAI 培训计划</strong>：GauntletAI 提供的培训计划，包括培训、工作机会和薪酬，吸引了对人工智能感兴趣的开发者。
    <ul>
      <li><a href="https://gauntletai.com">GauntletAI (YC S17) will fly you out, train you to build w AI, give you 200k job</a></li>
    </ul>
  </li>
  <li><strong>Haskell 程序语言</strong>：一篇文章讨论了 Haskell 作为程序语言的优势，特别是在过程式编程中的应用。
    <ul>
      <li><a href="https://entropicthoughts.com/haskell-procedural-programming">Haskell: A Great Procedural Language</a></li>
    </ul>
  </li>
  <li><strong>GitHub 新功能</strong>：GitHub 引入了子问题、问题类型和高级搜索功能，这些新特性旨在提高问题跟踪和管理的效率。
    <ul>
      <li><a href="https://github.blog/changelog/2025-01-13-evolving-github-issues-public-preview/">GitHub introduces sub-issues, issue types and advanced search</a></li>
    </ul>
  </li>
  <li><strong>图像文件显示难度</strong>：一篇文章探讨了在屏幕上显示图像文件内容的难度，涉及图像处理和显示技术。
    <ul>
      <li><a href="https://wolf.nereid.pl/posts/image-viewer/">How hard would it be to display the contents of an image file on the screen?</a></li>
    </ul>
  </li>
  <li><strong>Linux 网络编程指南</strong>：一个全面的 Linux 网络编程指南，为开发者提供了网络编程的基础知识和实践技巧。
    <ul>
      <li><a href="https://github.com/nguyenchiemminhvu/LinuxNetworkProgramming">About A comprehensive guide for Linux Network (Socket) programming</a></li>
    </ul>
  </li>
</ol>]]></content><author><name>Axpz</name><email>axpzhang@gmail.com</email></author><category term="hacknews" /><category term="news" /><category term="tech" /><summary type="html"><![CDATA[Hacker News 热门话题 2025-01-20 01:20:31]]></summary></entry><entry><title type="html">Kong start from api-gateway</title><link href="/kong/2025/01/16/kong-start-up.html" rel="alternate" type="text/html" title="Kong start from api-gateway" /><published>2025-01-16T06:43:43+00:00</published><updated>2025-01-16T06:43:43+00:00</updated><id>/kong/2025/01/16/kong-start-up</id><content type="html" xml:base="/kong/2025/01/16/kong-start-up.html"><![CDATA[<p>Kong Konnect Demo: https://www.youtube.com/watch?v=0XEtsyq_sUQ<br />
Get started with Kong gateway https://www.youtube.com/watch?v=hdE-rMAdYVY<br />
Kong Oauth https://www.youtube.com/watch?v=AIYIHZbDziI</p>

<p>Create your first API Gateway<br />
<img src="/assets/images/kong/Create_your_first_API_Gateway.png" alt="alt text" /></p>

<p>Add your first API<br />
<img src="/assets/images/kong/first_api.png" alt="alt text" /></p>

<p>Test your Gateway</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://kong-b3f5187d11usr19ve.kongcloud.dev/examples/weather/utopia
</code></pre></div></div>

<p>About this Route
Proxy URL:
https://kong-b3f5187d11usr19ve.kongcloud.dev/examples/weather/utopia</p>

<p>Upstream URL:
global.api.konghq.com/examples/weather/utopia</p>

<p>Upstream URL:
global.api.konghq.com/examples/weather/utopia</p>]]></content><author><name>Axpz</name><email>axpzhang@gmail.com</email></author><category term="kong" /><category term="kong" /><category term="api" /><category term="gateway" /><category term="ai" /><summary type="html"><![CDATA[Kong Konnect Demo: https://www.youtube.com/watch?v=0XEtsyq_sUQ Get started with Kong gateway https://www.youtube.com/watch?v=hdE-rMAdYVY Kong Oauth https://www.youtube.com/watch?v=AIYIHZbDziI]]></summary></entry><entry><title type="html">Hybrid cloud computing - Github CICD pipelines</title><link href="/k8s/2025/01/15/hybrid-cloud-computing-cicd-axpz.github.io.html" rel="alternate" type="text/html" title="Hybrid cloud computing - Github CICD pipelines" /><published>2025-01-15T15:18:15+00:00</published><updated>2025-01-15T15:18:15+00:00</updated><id>/k8s/2025/01/15/hybrid-cloud-computing-cicd-axpz.github.io</id><content type="html" xml:base="/k8s/2025/01/15/hybrid-cloud-computing-cicd-axpz.github.io.html"><![CDATA[<h1 id="混合云数据中心之cicd">混合云数据中心之CICD</h1>

<p>这是我要搭建的第一个服务：个人blog的CI/CD - 持续集成和持续部署</p>

<h2 id="目标">目标</h2>
<p>当xMinima repo有新的提交的时候，会自动触发流水线执行以下任务</p>
<ul>
  <li>自动构建（Build）</li>
  <li>集成与测试（Integration &amp; Testing）</li>
  <li>自动部署到 axpz.github.io</li>
</ul>

<h2 id="solutions">Solutions</h2>

<ol>
  <li>
    <p>使用Github Actions, 从企业级开发来讲，我推荐使用Github Actions。</p>

    <p>Pros: 
   易用性：即开即用，集成度高，支持大量插件和模板。
   维护性低：由 GitHub 官方管理，无需自行维护基础设施。
   社区支持：活跃社区，有大量教程和最佳实践。</p>

    <p>Cons:
   成本：对于大型企业和高频执行，费用较高。
   灵活性受限：不适合特别复杂或定制化的 CI/CD 流程。</p>
  </li>
  <li>
    <p>自建pipeline，从full control和 cost down的角度，我建议自建pipeline。</p>

    <p>Pros:
   完全控制：可以根据需求高度定制和优化。
   成本控制：对于大规模任务，长期来看更具经济性。
   安全性：代码和数据完全掌控在内部网络中。</p>

    <p>Cons:
   开发/维护成本高：需要专门团队维护 CI/CD 基础设施。
   上手难度：初期搭建和优化可能较复杂，耗时较长。</p>
  </li>
</ol>

<p>别忘了我们的关键词是cost-effective。那上一篇文章中，我们已经自行搭建了基础设置，那我们自行build pipeline自然是顺理成章的事情，这个不难，至少对我们来讲。</p>

<h2 id="implementationgithub-自建-cicd-流水线设计与实施方案">Implementation：GitHub 自建 CI/CD 流水线设计与实施方案</h2>

<h3 id="整体架构">整体架构</h3>
<p>整体架构分为四个部分</p>
<ol>
  <li>Webhook 事件触发：
    <ul>
      <li>GitHub 触发 Webhook。</li>
    </ul>
  </li>
  <li>Ingress 路由：
    <ul>
      <li>请求通过 Kubernetes Ingress 转发到服务。</li>
    </ul>
  </li>
  <li>事件处理：
    <ul>
      <li>服务解析事件并触发流水线。</li>
    </ul>
  </li>
  <li>流水线执行：
    <ul>
      <li>自动构建、测试与部署。
整体架构图
<img src="/assets/images/high-level-arch-github-cicd.png" alt="github cicd" />
        <h4 id="1-webhook-事件订阅">1. Webhook 事件订阅</h4>
        <p>通过注册 <strong>GitHub Webhook</strong> 接收以下事件：
     - <strong>pull_request</strong>：用于监控 Pull Request 的状态，如创建、更新、合并等。
     - <strong>push</strong>：用于监控代码分支的变更（如 <code class="language-plaintext highlighter-rouge">git push</code> 或 <code class="language-plaintext highlighter-rouge">git push --force</code>）。</p>
      </li>
    </ul>
  </li>
</ol>

<p><strong>功能：</strong></p>
<ul>
  <li>实时监听仓库的关键事件。</li>
  <li>根据触发条件将事件传递给处理服务。</li>
</ul>

<p><strong>实现：</strong>
<img src="/assets/images/github-webhook-cicd.png" alt="github webhook" /></p>

<hr />

<h4 id="2-ingress-路由配置">2. Ingress 路由配置</h4>
<p>使用 <strong>Kubernetes Ingress</strong> 将外部请求路由到 <strong>GitHub Agent Server</strong>。</p>

<p><strong>配置要点：</strong></p>
<ul>
  <li>定义 Ingress 规则：将 GitHub Webhook 请求（如 <code class="language-plaintext highlighter-rouge">/github/webhook</code>）路由到服务的特定端点。</li>
  <li>[Options] 启用 HTTPS 支持：通过证书管理（如 Cert-Manager）实现安全通信。</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">traefik.containo.us/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">IngressRoute</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">github-agent-server</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">entryPoints</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">web</span>
  <span class="na">routes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">Rule</span>
    <span class="na">match</span><span class="pi">:</span> <span class="s">Host(`74.121.149.207`) &amp;&amp; PathPrefix(`/github/webhook`)</span>
    <span class="na">services</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">github-agent-server</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">github-agent-server</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">github-agent-server</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8080</span>

</code></pre></div></div>

<hr />

<h4 id="3-event-处理与流水线触发">3. Event 处理与流水线触发</h4>
<p>服务接收 Webhook 事件后，执行以下操作：</p>
<ol>
  <li><strong>解析事件内容</strong>：
    <ul>
      <li>提取关键信息（如事件类型、分支、Pull Request 状态等）。</li>
    </ul>
  </li>
  <li><strong>检测特定条件</strong>：
    <ul>
      <li>Pull Request 合并（<code class="language-plaintext highlighter-rouge">pull_request merged</code>）。</li>
      <li>强制推送（<code class="language-plaintext highlighter-rouge">git push --force</code>）。</li>
    </ul>
  </li>
  <li><strong>触发流水线 Jobs</strong>：
    <ul>
      <li>满足条件时启动相关流水线任务。</li>
    </ul>
  </li>
</ol>

<hr />

<h4 id="4-流水线-jobs">4. 流水线 Jobs</h4>
<p>流水线的主要任务包括以下阶段：</p>

<h5 id="自动构建build">自动构建（Build）</h5>
<ul>
  <li>编译代码，生成构建产物（如前端资源、可执行文件等）。</li>
  <li>确保构建无错误。</li>
</ul>

<h5 id="集成与测试integration--testing">集成与测试（Integration &amp; Testing）</h5>
<ul>
  <li>执行单元测试、集成测试和端到端测试。</li>
  <li>生成测试报告，确保代码质量。</li>
</ul>

<h5 id="部署到-axpzgithubio">部署到 axpz.github.io</h5>
<ul>
  <li>将构建产物部署到 <code class="language-plaintext highlighter-rouge">axpz.github.io</code>，实现自动化发布。</li>
  <li>[day2] 支持版本控制与回滚机制。</li>
</ul>

<p>创建secret存放github private key</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create secret generic github-ssh-key-secret <span class="nt">--from-file</span><span class="o">=</span><span class="nv">id_rsa</span><span class="o">=</span>/home/ubuntu/.ssh/id_isa <span class="nt">--from-file</span><span class="o">=</span><span class="nv">known_hosts</span><span class="o">=</span>/home/ubuntu/.ssh/known_hosts
</code></pre></div></div>

<p>对于不同的hardware architecture，可能需要自建一个docker image</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; Dockerfile
FROM ruby:latest
RUN gem install jekyll bundler jekyll-seo-tag csv base64
</span><span class="no">EOF

</span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; Dockerfile2
FROM ruby:3.2-alpine

ENV BUNDLER_VERSION=2.4.13 </span><span class="se">\</span><span class="sh">
    JEKYLL_VERSION=4.3.2 </span><span class="se">\</span><span class="sh">
    BUILD_DEPS="build-base gcc libxml2-dev libxslt-dev readline-dev" </span><span class="se">\</span><span class="sh">
    RUNTIME_DEPS="tzdata bash"

RUN apk add --no-cache </span><span class="nv">$BUILD_DEPS</span><span class="sh"> </span><span class="nv">$RUNTIME_DEPS</span><span class="sh"> &amp;&amp; </span><span class="se">\</span><span class="sh">
    gem install jekyll:</span><span class="nv">$JEKYLL_VERSION</span><span class="sh"> bundler:</span><span class="nv">$BUNDLER_VERSION</span><span class="sh"> jekyll-seo-tag csv base64 &amp;&amp; </span><span class="se">\</span><span class="sh">
    apk del </span><span class="nv">$BUILD_DEPS</span><span class="sh"> &amp;&amp; </span><span class="se">\</span><span class="sh">
    rm -rf /var/cache/apk/* /usr/lib/lib/ruby/gems/*/cache/*

WORKDIR /app

CMD ["jekyll", "--help"]
</span><span class="no">EOF


</span>docker build <span class="nt">-t</span> jekyll-cicd:4.3.2 <span class="nb">.</span>
docker save <span class="nt">-o</span> /tmp/jekyll-cicd.tar jekyll-cicd:4.3.2
ctr <span class="nt">-n</span><span class="o">=</span>k8s.io images import /tmp/snap-private-tmp/snap.docker/tmp/jekyll-cicd.tar
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cicd-job</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cicd-container</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">jekyll-cicd</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">/bin/bash</span>
        <span class="pi">-</span> <span class="s">-c</span>
        <span class="pi">-</span> <span class="pi">|</span>
          <span class="s">set -ex</span>
          <span class="s">git config --global user.name "Axpz"</span>
          <span class="s">git config --global user.email "axpzhang@gmail.com"</span>

          <span class="s">echo "Cloning repository..."</span>
          <span class="s">git clone git@github.com:Axpz/xMinima.git</span>
          <span class="s">echo "Running release script..."</span>
          <span class="s">cd xMinima </span>
          <span class="s">bash -x script/bootstrap</span>
          <span class="s">commitMsg=`git log -1 --pretty=%B`</span>
          <span class="s">bash -x script/release.axpz.github.io "$commitMsg"</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">GIT_SSH_COMMAND</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ssh</span><span class="nv"> </span><span class="s">-o</span><span class="nv"> </span><span class="s">StrictHostKeyChecking=no"</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">github-ssh-keys</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/root/.ssh</span>
          <span class="na">readOnly</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Never</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">github-ssh-keys</span>
        <span class="na">secret</span><span class="pi">:</span>
          <span class="na">secretName</span><span class="pi">:</span> <span class="s">github-ssh-key-secret</span> <span class="c1"># 请确保预先创建了此 Secret</span>
          <span class="na">defaultMode</span><span class="pi">:</span> <span class="m">0600</span>
  <span class="na">backoffLimit</span><span class="pi">:</span> <span class="m">0</span> <span class="c1"># 任务失败后不重试</span>
  <span class="na">ttlSecondsAfterFinished</span><span class="pi">:</span> <span class="m">60</span> <span class="c1"># 在任务完成 60 秒后删除 Job</span>
</code></pre></div></div>]]></content><author><name>Axpz</name><email>axpzhang@gmail.com</email></author><category term="k8s" /><category term="kubernetes" /><category term="k8s" /><category term="k3s" /><category term="golang" /><category term="cloud" /><category term="ai" /><summary type="html"><![CDATA[混合云数据中心之CICD]]></summary></entry><entry><title type="html">Kubernetes personal hybrid cloud edge computing</title><link href="/k8s/2025/01/12/kubernetes-personal-hybrid-cloud-edge-computing.html" rel="alternate" type="text/html" title="Kubernetes personal hybrid cloud edge computing" /><published>2025-01-12T06:43:43+00:00</published><updated>2025-01-12T06:43:43+00:00</updated><id>/k8s/2025/01/12/kubernetes-personal-hybrid-cloud-edge-computing</id><content type="html" xml:base="/k8s/2025/01/12/kubernetes-personal-hybrid-cloud-edge-computing.html"><![CDATA[<!-- Header Section -->
<h1 id="基于k3s搭建个人混合云数据中心高效利用边缘计算与云服务">基于k3s搭建个人混合云数据中心：高效利用边缘计算与云服务</h1>

<!-- Navigation Bar -->
<h2 id="目录">目录</h2>
<ol>
  <li><a href="#背景与问题">背景与问题</a></li>
  <li><a href="#实现方案">实现方案</a>
    <ul>
      <li><a href="#方案1-集群混合部署公有云计算节点和私有云计算节点混合部署">方案1: 集群混合部署：公有云计算节点和私有云计算节点混合部署</a></li>
      <li><a href="#方案2-集群部署在私有计算节点上使用公有云节点当作ingress">方案2: 集群部署在私有计算节点上，使用公有云节点当作ingress</a></li>
      <li><a href="#方案3-公有云节点上部署网关，直接转发服务到私有计算节点">方案3: 公有云节点上部署网关，直接转发服务到私有计算节点</a></li>
    </ul>
  </li>
  <li><a href="#测试">测试</a></li>
</ol>

<!-- Main Content Section -->
<h2 id="背景与问题">背景与问题</h2>
<p>随着云计算和边缘计算技术的不断发展，个人用户在使用云主机时面临着一个不可忽视的问题：随着计算需求的增加，云主机的费用也随之增长。这对于那些有特定计算需求，但又不希望一直支付高额云费用的个人用户来说，构建一个混合云架构显得尤为重要。</p>

<p>在传统的云计算模式下，用户的数据和计算任务会被完全转移到云数据中心，随着计算量和存储需求的增加，云计算的费用也会显著提升。而对于许多家庭用户来说，往往有较强的本地计算能力——例如，个人闲置的家用计算机通常配备了较高的硬件配置（如多核CPU、大量内存和硬盘存储），但是由于这些设备并未得到充分利用，造成了资源的浪费。</p>

<p>因此，将边缘计算能力与云服务结合，搭建一个个人混合云数据中心，成为解决这一问题的理想方案。通过这种方式，用户可以充分利用本地计算机的闲置资源，将一些计算密集型任务和存储任务转移到本地边缘节点上，而将需要更高可用性、灵活性或规模的任务交给公有云来处理。</p>

<h3 id="这种架构的优势">这种架构的优势：</h3>
<ol>
  <li><strong>降低云计算成本</strong>：通过将部分计算和存储任务转移到本地边缘节点，减少了对云服务的依赖，进而减少了云计算的费用。</li>
  <li><strong>高效利用闲置资源</strong>：充分利用家用计算机等本地设备的计算和存储能力，避免了硬件资源的浪费。</li>
  <li><strong>降低网络延迟</strong>：将边缘计算部署在离数据源更近的地方，减少了网络延迟，尤其适用于延迟敏感型应用。</li>
  <li><strong>灵活性与可扩展性</strong>：通过公有云和本地计算机的结合，用户可以灵活调度和扩展资源，既能保证高效性，也能提供类似公有云的管理体验。</li>
</ol>

<p>然而，在实现个人混合云数据中心时，仍然面临一些挑战，特别是在网络连接、同步以及资源的调度与管理方面。例如，如何有效地连接本地设备与云服务，保证数据的安全与同步？如何在网络延迟较高的情况下，确保系统稳定运行？</p>

<p>因此，搭建一个既能减少云计算成本，又能高效利用本地硬件资源的个人混合云数据中心，变成了一个有意思的事情。</p>

<h2 id="实现方案">实现方案</h2>
<p>这里我们尝试两种方案</p>
<ol>
  <li>集群混合部署：公有云计算节点和私有云计算节点混合部署</li>
  <li>集群部署在私有计算节点上，使用公有云节点当作ingress</li>
  <li>公有云节点上部署网关，直接转发服务到私有计算节点</li>
</ol>

<h3 id="方案1-集群混合部署公有云计算节点和私有云计算节点混合部署">方案1: 集群混合部署：公有云计算节点和私有云计算节点混合部署</h3>
<p>传统的方案通常将私有云和公有云独立架构，然后使用常用中间件来打通数据流和控制流，这种方式往往增加了运维复杂度，尤其是在数据交互和安全管理方面的挑战。特别是在省钱省事的前提下，成为了安全和运维的难点。本文尝试一种新的解决方案：通过K8s实现公有云和私有计算中心的统一，利用K8s的原生能力来解决网络连接、延迟等带来的数据同步，安全运维等问题。这个方案通过横向扩展两个网络，尝试实现更加高效和简化的云数据中心架构，提供了一个实用的实践方向。</p>

<p><img src="/assets/images/high-level-arch-hybrid-cluster.png" alt="high level arch" /></p>

<h4 id="打通网络">打通网络</h4>
<p>第一步应该是打通本地主机到云主机的网络，如上图中虚线所示，我们使用wireguard (被Linus成为“the best VPN protocol”)</p>

<ol>
  <li>
    <p>配置wireguard server，我们标记为A，执行下面脚本 — 注意注释掉的部分</p>

    <details>

 ```bash
 #!/bin/bash

 # wireguard server A
 mkdir -p /wireguard
 cd /wireguard
 wg genkey | tee server_A_private_key | wg pubkey &gt; server_A_public_key

 if [ ! -f /wireguard/client_B_public_key ]; then
     echo "file client public key does not exist"
     exit 1
 fi

 cat &lt;<EOF> /wireguard/wg0.conf
 [Interface]
 PrivateKey = `cat /wireguard/server_A_private_key` # private key of server A
 Address = 10.4.0.1/24      # virtual server IP of A node
 ListenPort = 51820
 SaveConfig = true

 [Peer]
 PublicKey = `cat /wireguard/client_B_public_key`
 AllowedIPs = 10.4.0.2/32   # virtual IP of B node
 EOF

 cp /wireguard/wg0.conf /etc/wireguard/wg0.conf

 sudo wg-quick up wg0
 #sudo systemctl enable wg-quick@wg0

 #sudo ufw allow 51820/udp
 #sudo ufw enable

 #希望 B 设备通过 A 访问 Internet 或其他网络资源，你需要在 A 上配置 IP 转发
 # 启用 IP 转发
 #echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward

 # 修改 sysctl 配置以保持设置
 #sudo sysctl -w net.ipv4.ip_forward=1
 #sudo sysctl -p
 #
 #sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
 #sudo iptables-save
 ```

 &lt;/details&gt;

</EOF></details>
  </li>
  <li>
    <p>配置peer client 节点，我们标记为B（同理可以创建C节点），执行下面脚本 — 注意注释掉的部分</p>

    <details>

 ```bash
 #!/bin/bash

 # wireguard client B
 mkdir -p /wireguard
 cd /wireguard
 wg genkey | tee client_B_private_key | wg pubkey &gt; client_B_public_key

 if [ ! -f /wireguard/server_A_public_key ]; then
     echo "file server public key does not exist"
     exit 1
 fi

 cat &lt;<EOF> /etc/wireguard/wg0.conf
 [Interface]
 PrivateKey = `cat /wireguard/client_B_private_key` # private key of B
 Address = 10.4.0.2/32      # virtual server IP of B

 [Peer]
 PublicKey = `cat /wireguard/server_A_public_key`
 Endpoint = 74.121.149.207:51820 # public IP and listening port
 AllowedIPs = 10.4.0.0/24   # virtual IP of B node
 PersistentKeepalive = 25
 EOF

 cp /wireguard/wg0.conf /etc/wireguard/wg0.conf

 sudo wg-quick up wg0
 #sudo systemctl enable wg-quick@wg0 # start on system on
 ```

 &lt;/details&gt;

</EOF></details>
  </li>
  <li>
    <p>测试链接，ping 成功搞定</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ping 10.4.0.1
 PING 10.4.0.1 <span class="o">(</span>10.4.0.1<span class="o">)</span>: 56 data bytes
 64 bytes from 10.4.0.1: <span class="nv">icmp_seq</span><span class="o">=</span>0 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>300.125 ms
 64 bytes from 10.4.0.1: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>320.622 ms
</code></pre></div>    </div>
  </li>
</ol>

<h4 id="搭建k3s-control-plane-on-cloud">搭建k3s control plane on cloud</h4>
<p>登录到A节点，启动controlplane</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-sfL</span> https://get.k3s.io | sh -
</code></pre></div></div>
<p>根据个人环境优化参数，如·网络丢包率为 12%，延时约 250ms·，建议优化启动参数.
也可以使用默认参数，目前默认行为k3s</p>
<ol>
  <li>启动sqlite存储</li>
  <li>Kubelet默认同步node节点数据频率为1分钟一次</li>
  <li>默认API Server 等待状态更新的最大容忍时间为5m
```/etc/systemd/system/k3s.service
ExecStart=/usr/local/bin/k3s server –tls-san axpz.local</li>
</ol>

<p>…</p>

<p>–kubelet-arg=–node-status-update-frequency=60s
–kubelet-arg=–node-status-update-grace-period=5m</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code></code></pre></div></div>
<p>sudo systemctl daemon-reload
sudo systemctl restart k3s</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>查看日志
    
&lt;details&gt;
    
```bash  
# 使用以下命令来过滤 K3s 日志中的 Node Token 和 TLS-SAN 信息
# journalctl -u k3s | grep 'node token\|tls-san'

Jan 07 15:30:36 calm-baud-1.localdomain k3s[3094620]: time="2025-01-07T15:30:36Z" level=info msg="Server node token is available at /var/lib/rancher/k3s/server/token"
Jan 07 15:30:36 calm-baud-1.localdomain k3s[3094620]: time="2025-01-07T15:30:36Z" level=info msg="Agent node token is available at /var/lib/rancher/k3s/server/agent-token"
Jan 07 15:30:47 calm-baud-1.localdomain k3s[3094779]: time="2025-01-07T15:30:47Z" level=info msg="Server node token is available at /var/lib/rancher/k3s/server/token"
Jan 07 15:30:47 calm-baud-1.localdomain k3s[3094779]: time="2025-01-07T15:30:47Z" level=info msg="Agent node token is available at /var/lib/rancher/k3s/server/agent-token"
Jan 07 15:30:54 calm-baud-1.localdomain k3s[3094779]: I0107 15:30:54.121292 3094779 kube.go:636] List of node(calm-baud-1.localdomain) annotations: map[string]string{"alpha.kubernetes.io/provided-node-ip":"74.121.149.207", "flannel.alpha.coreos.com/backend-data":"{\"VNI\":1,\"VtepMAC\":\"3e:a5:8d:f1:50:b4\"}", "flannel.alpha.coreos.com/backend-type":"vxlan", "flannel.alpha.coreos.com/kube-subnet-manager":"true", "flannel.alpha.coreos.com/public-ip":"74.121.149.207", "k3s.io/hostname":"calm-baud-1.localdomain", "k3s.io/internal-ip":"74.121.149.207", "k3s.io/node-args":"[\"server\",\"--tls-san\",\"axpz.local\"]", "k3s.io/node-config-hash":"EW5CHGDY6WQFH5IMOMMGEEEOFXADTGZZPMW5RZGHVQBJ3QHTZUHA====", "k3s.io/node-env":"{}", "node.alpha.kubernetes.io/ttl":"0", "volumes.kubernetes.io/controller-managed-attach-detach":"true"}
</code></pre></div></div>

<p>&lt;/details&gt;</p>

<h4 id="启动traefik-dashboard">启动traefik dashboard</h4>
<p>edit /var/lib/rancher/k3s/server/manifests/traefik.yaml with</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: traefik
  namespace: kube-system
spec:
  chart: https://%{KUBERNETES_API}%/static/charts/traefik-27.0.201+up27.0.2.tgz
  set:
    global.systemDefaultRegistry: ""
    dashboard.enabled: "true"               &lt;&lt;&lt;
    dashboard.domain: "traefik.internal"    &lt;&lt;&lt;
</code></pre></div></div>
<p>kubectl apply -f /var/lib/rancher/k3s/server/manifests/traefik.yaml</p>

<h4 id="搭建k3s-worker-on-macos">搭建k3s worker on <code class="language-plaintext highlighter-rouge">macOS</code></h4>
<p>首先启动一个轻量级虚拟机</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>multipass launch <span class="nt">--name</span> k3s-worker <span class="nt">--memory</span> 4G <span class="nt">--disk</span> 40G <span class="nt">--mount</span> ~/go/src/github.com:/mnt/github.com
multipass shell k3s-worker
curl <span class="nt">-sfL</span> https://get.k3s.io | <span class="nv">K3S_URL</span><span class="o">=</span>https://axpz.local:6443 <span class="nv">K3S_TOKEN</span><span class="o">=</span>K10...d0eb56c9 sh -
</code></pre></div></div>

<h4 id="系统搭建完成注意下面几点">系统搭建完成，注意下面几点</h4>

<ol>
  <li>云主机的公网IP会自动被treafik的serviceLB创建为LoadBalancer IP，即默认的ingress，你可以通过配置ingressRoute自动分流到到不同的微服务中。</li>
  <li>如果各个节点硬件的architecture不一样，需要注意kubernetes的image兼容性问题，比如controlplane是x86-64, 而工作节点是arm64，可能需要额外的工作。</li>
  <li>优化：
    <ul>
      <li>优化启动参数：比如上面提到的网络丢包率为 12%，延时约 250ms，需要优化数据同步频率，以及存储等, 比如：<code class="language-plaintext highlighter-rouge">ExecStart=/usr/local/bin/k3s server --tls-san axpz.local --flannel-backend=none --disable-network-policy --no-deploy local-storage --no-deploy traefik</code></li>
      <li>减少主节点资源消耗：给主节点打污点 <code class="language-plaintext highlighter-rouge">kubectl taint nodes calm-baud-1.localdomain node-role.kubernetes.io/master:NoSchedule</code></li>
      <li>网络优化，如果作为生产级应用，建议搭建网络专线</li>
      <li>其他…</li>
    </ul>
  </li>
</ol>

<h3 id="方案2-集群部署在私有计算节点上使用公有云节点当作ingress">方案2: 集群部署在私有计算节点上，使用公有云节点当作ingress</h3>

<p><img src="/assets/images/high-level-arch-private-cluster.png" alt="high level arch" /></p>

<h4 id="打通网络搭建集群">打通网络、搭建集群</h4>

<p>参考方案1的实现, 同时注意添加dnat</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-A</span> PREROUTING <span class="nt">-p</span> tcp <span class="nt">--dport</span> 80 <span class="nt">-d</span> 74.121.149.207 <span class="nt">-j</span> DNAT <span class="nt">--to-destination</span> 10.4.0.3:80
<span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-A</span> PREROUTING <span class="nt">-p</span> tcp <span class="nt">--dport</span> 443 <span class="nt">-d</span> 74.121.149.207 <span class="nt">-j</span> DNAT <span class="nt">--to-destination</span> 10.4.0.3:443
<span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-A</span> POSTROUTING <span class="nt">-o</span> eth0 <span class="nt">-j</span> MASQUERADE
<span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-A</span> POSTROUTING <span class="nt">-o</span> wg0 <span class="nt">-j</span> MASQUERADE
</code></pre></div></div>

<h4 id="配置集群负载均衡为wg0">配置集群负载均衡为wg0</h4>

<p>k3s 使用serviceLB来提供负载均衡服务，当有external-ip 时，serviceLB会自动使用其作为负载均衡，当没有的时候会自动使用internal ip作为负载均衡，由于我们配置了vpn连通外网，所以我们配置wg0作为外网ip，具体配置添加启动参数
–node-external-ip 10.4.0.3
所以启动service变为ExecStart=/usr/local/bin/k3s server –node-external-ip 10.4.0.3</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl stop k3s
systemctl start k3s
</code></pre></div></div>

<h3 id="方案3-公有云节点上部署网关直接转发服务到私有计算节点">方案3: 公有云节点上部署网关，直接转发服务到私有计算节点</h3>
<p>从原理上来讲，和方案二没有太大的区别，但是考虑到kubernetes的ingress本身就是一个网关的功能，所以如果这里再添加一层网关难免有重复的嫌疑。所以从最大程度利用kubernetes的能力和避免重复造轮子的角度，方案二还是最优解。在此从造轮子的角度，也不妨给出一个架构图，但我们不做更深入讨论。
<img src="/assets/images/high-level-arch-device-plugin.png" alt="alt text" /></p>

<p>顺便提一下这个更像是一个业务代码的实现架构，确实是，其实这个代码已经完成，这里的设计和实现是我参靠kubelet和Nvidia的deviceplugin的架构，那接下来的我们也会基于这个来实现我们的Agent的后端业务。</p>

<h3 id="测试">测试</h3>
<p>本测试基于方案二完成. 当然方案1也是可以用的，需要注意的是，方案一必须要依赖multi-platform的images，同时在业务调度的时候也需要考虑不同的硬件平台).</p>

<ol>
  <li>创建nginx应用
    <details>

 ``` yaml
 apiVersion: apps/v1 
 kind: Deployment 
 metadata:
 name: nginx-deployment
 namespace: default
 spec:
 replicas: 1
 selector:
     matchLabels:
     app: nginx
 template:
     metadata:
     labels:
         app: nginx
     spec:
     containers:
     - name: nginx
         image: nginx:latest
         ports:
         - containerPort: 80
 ---
 apiVersion: apps/v1
 kind: Deployment
 metadata:
 name: nginx-deployment2
 namespace: default
 spec:
 replicas: 1
 selector:
     matchLabels:
     app: nginx2
 template:
     metadata:
     labels:
         app: nginx2
     spec:
     containers:
     - name: nginx
         image: nginx:latest
         ports:
         - containerPort: 80
 ```

 </details>
  </li>
  <li>暴露服务
    <details>

 ``` yaml
 apiVersion: v1
 kind: Service
 metadata:
 name: nginx-service
 namespace: default
 spec:
 selector:
     app: nginx
 ports:
     - protocol: TCP
     port: 80
     targetPort: 80
 # 这个服务类型可以改成 ClusterIP 或者 NodePort
 type: ClusterIP
 ```

 </details>
  </li>
  <li>配置IngressRoute
    <details>

 ``` yaml
 apiVersion: traefik.containo.us/v1alpha1
 kind: IngressRoute
 metadata:
 name: nginx-ingressroute
 namespace: default
 spec:
 entryPoints:
     - web   # 确保 Traefik 配置了 `web` entry point
 routes:
     - match: Host(`k3s.local`)  # 使用你自己的域名，或者可以用外部 IP
     kind: Rule
     services:
         - name: nginx-service
         port: 80
     - match: Host(`k3s.local`) &amp;&amp; PathPrefix(`/n2`)
     kind: Rule
     services:
         - name: nginx-service2
         port: 80
 ```
 </details>
  </li>
</ol>

<p>从互联网访问，…, 搞定, scale up/down pod， … 搞定</p>

<p>至此，我们的platform层和infra层搭建完成，接下来我们会基于我们的业务完善DevOps，包括监控和CI/CD。</p>

<!-- Footer Section -->
<div class="footer">
    <p>© 2025 基于kubernetes搭建个人混合云数据中心项目</p>
</div>]]></content><author><name>Axpz</name><email>axpzhang@gmail.com</email></author><category term="k8s" /><category term="kubernetes" /><category term="k8s" /><category term="k3s" /><category term="golang" /><category term="cloud" /><category term="ai" /><summary type="html"><![CDATA[基于k3s搭建个人混合云数据中心：高效利用边缘计算与云服务]]></summary></entry></feed>